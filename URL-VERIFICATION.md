# URL Verification Across Environments

## How URLs Work in Each Environment

### Environment Variable Priority

The URL resolution follows this chain in `astro.config.mjs`:
```javascript
site: process.env.URL || process.env.DEPLOY_URL || 'https://pwv.com'
```

### 1. üñ•Ô∏è Local Development

**Environment Variables Set**: None (or manually set by developer)

**URLs Used**:
- **Astro Config (`site`)**: `https://pwv.com` (fallback)
- **Canonical URLs**: `https://pwv.com/*`
- **Sitemap URLs**: `https://pwv.com/*`
- **RSS Feed URLs**: `https://pwv.com/*`
- **OG URLs**: `https://pwv.com/*`

**Why Production URLs in Local Dev?**
- Ensures local builds match production exactly
- HTML generated locally can be tested with correct canonical URLs
- Prevents localhost URLs from accidentally making it to production

**Testing Locally**:
```bash
# Build locally
pnpm run build

# Verify URLs
grep -o 'rel="canonical" href="[^"]*"' dist/index.html
# Should output: rel="canonical" href="https://pwv.com/"

# Check RSS feed
grep -o '<link>[^<]*</link>' dist/rss.xml | head -5
# Should show: <link>https://pwv.com/...</link>
```

**Override for Local Testing** (if needed):
```bash
# Run dev server with localhost URLs
URL=http://localhost:4321 pnpm run dev
```

---

### 2. üîç Netlify Deploy Preview

**Environment Variables Set by Netlify**:
- `CONTEXT=deploy-preview`
- `DEPLOY_PRIME_URL=https://deploy-preview-123--pwv.netlify.app`
- `DEPLOY_URL=https://deploy-preview-123--pwv.netlify.app`

**URLs Used**:
- **Astro Config (`site`)**: `https://deploy-preview-123--pwv.netlify.app` (from DEPLOY_URL)
- **Canonical URLs (HTML pages)**: `https://deploy-preview-123--pwv.netlify.app/*`
  - Uses special logic in `Layout.astro` that detects `CONTEXT=deploy-preview`
- **Sitemap URLs**: `https://deploy-preview-123--pwv.netlify.app/*`
- **RSS Feed URLs**: `https://deploy-preview-123--pwv.netlify.app/*`
- **OG URLs**: `https://deploy-preview-123--pwv.netlify.app/*`

**Why Deploy Preview URLs?**
- Allows testing the exact HTML that will be generated
- Canonical URLs point to preview URL so links work correctly
- Preview is isolated from production for safe testing

**Special Logic in Layout.astro**:
```javascript
const isDeployPreview = process.env.CONTEXT === 'deploy-preview';
const baseURL = isDeployPreview
  ? process.env.DEPLOY_PRIME_URL || Astro.site
  : Astro.site;
```

**Testing Deploy Preview**:
1. Create a PR or deploy to a branch
2. Netlify generates preview (e.g., `https://deploy-preview-123--pwv.netlify.app`)
3. Visit the preview site
4. View source on any page
5. Check canonical URLs use the preview domain:
   ```html
   <link rel="canonical" href="https://deploy-preview-123--pwv.netlify.app/news">
   ```

---

### 3. üöÄ Production

**Environment Variables Set by Netlify**:
- `CONTEXT=production`
- `URL=https://pwv.com` (set in netlify.toml)
- Netlify also sets its own URLs but our explicit setting takes precedence

**URLs Used**:
- **Astro Config (`site`)**: `https://pwv.com` (from netlify.toml context.production.environment)
- **Canonical URLs**: `https://pwv.com/*`
- **Sitemap URLs**: `https://pwv.com/*`
- **RSS Feed URLs**: `https://pwv.com/*`
- **OG URLs**: `https://pwv.com/*`

**Why Explicit Production URL?**
- Ensures production always uses correct domain
- No risk of environment variable issues
- Consistent with DNS configuration

**Netlify Configuration**:
```toml
[context.production.environment]
  URL = "https://pwv.com"
```

**Testing Production**:
```bash
# Visit any production page
curl -s https://pwv.com/news | grep -o 'rel="canonical" href="[^"]*"'
# Should output: rel="canonical" href="https://pwv.com/news"

# Check sitemap
curl -s https://pwv.com/sitemap-index.xml
# Should contain: <loc>https://pwv.com/...</loc>

# Check RSS feed
curl -s https://pwv.com/rss.xml | grep -o '<link>[^<]*</link>' | head -3
# Should show: <link>https://pwv.com/...</link>
```

---

## Sitemap URL Handling

The sitemap is generated by `@astrojs/sitemap` integration, which:
- Uses `site` from `astro.config.mjs`
- Automatically generates URLs for all pages
- Respects the `serialize` and `filter` functions we configured

**Verification**:
```bash
# Local/Production
cat dist/sitemap-index.xml | grep -o 'https://[^<]*'

# Should show production URLs in all cases
```

**Note**: Sitemap always uses the URL from `astro.config.mjs`, which is:
- Local: `https://pwv.com`
- Deploy Preview: `https://deploy-preview-123--pwv.netlify.app`
- Production: `https://pwv.com`

---

## RSS Feed URL Handling

The RSS feed (`src/pages/rss.xml.ts`) uses:
```javascript
const site = context.site || import.meta.env.SITE || 'https://pwv.com';
```

Where `context.site` comes from Astro's configured `site` URL.

**Feed Items** include:
```xml
<item>
  <title>Post Title</title>
  <link>https://pwv.com/news/post-slug</link>
  <guid>https://pwv.com/news/post-slug</guid>
</item>
```

**Verification**:
```bash
# Check RSS feed URLs
curl -s https://pwv.com/rss.xml | grep '<link>' | head -5
```

---

## Summary Table

| Environment | Canonical URLs | Sitemap URLs | RSS URLs | OG URLs |
|-------------|---------------|--------------|----------|---------|
| **Local Dev** | `https://pwv.com/*` | `https://pwv.com/*` | `https://pwv.com/*` | `https://pwv.com/*` |
| **Deploy Preview** | `https://deploy-preview-123--pwv.netlify.app/*` | `https://deploy-preview-123--pwv.netlify.app/*` | `https://deploy-preview-123--pwv.netlify.app/*` | `https://deploy-preview-123--pwv.netlify.app/*` |
| **Production** | `https://pwv.com/*` | `https://pwv.com/*` | `https://pwv.com/*` | `https://pwv.com/*` |

---

## Key Configuration Files

### astro.config.mjs
```javascript
site: process.env.URL || process.env.DEPLOY_URL || 'https://pwv.com'
```
- Checks URL first (set by netlify.toml for production)
- Falls back to DEPLOY_URL (set by Netlify for previews)
- Final fallback to production URL

### netlify.toml
```toml
[context.production.environment]
  URL = "https://pwv.com"
```
- Only sets URL for production builds
- Deploy previews use Netlify's automatic DEPLOY_URL

### src/layouts/Layout.astro
```javascript
const isDeployPreview = process.env.CONTEXT === 'deploy-preview';
const baseURL = isDeployPreview
  ? process.env.DEPLOY_PRIME_URL || Astro.site
  : Astro.site;
```
- Special handling for deploy preview canonical URLs
- Uses DEPLOY_PRIME_URL when in preview context

### src/pages/rss.xml.ts
```javascript
const site = context.site || import.meta.env.SITE || 'https://pwv.com';
```
- Uses Astro's configured site URL
- Inherits from astro.config.mjs

---

## Testing Checklist

### ‚úÖ Local Development
- [ ] Build: `pnpm run build`
- [ ] Check canonical in `dist/index.html`: should be `https://pwv.com/`
- [ ] Check sitemap in `dist/sitemap-index.xml`: should contain `https://pwv.com/*`
- [ ] Check RSS in `dist/rss.xml`: should contain `https://pwv.com/*`

### ‚úÖ Deploy Preview
- [ ] Create PR or deploy to branch
- [ ] Wait for Netlify preview build
- [ ] Visit preview URL (e.g., `https://deploy-preview-123--pwv.netlify.app`)
- [ ] View source ‚Üí check canonical uses preview URL
- [ ] Visit `/sitemap-index.xml` ‚Üí should use preview URL
- [ ] Visit `/rss.xml` ‚Üí should use preview URL

### ‚úÖ Production
- [ ] Deploy to main branch
- [ ] Visit `https://pwv.com`
- [ ] View source ‚Üí check canonical is `https://pwv.com/*`
- [ ] Visit `https://pwv.com/sitemap-index.xml` ‚Üí should use `https://pwv.com/*`
- [ ] Visit `https://pwv.com/rss.xml` ‚Üí should use `https://pwv.com/*`
- [ ] Test in Google Search Console URL Inspection

---

## Troubleshooting

### Issue: Deploy preview shows production URLs

**Cause**: `URL` environment variable is set globally instead of context-specific

**Fix**: Ensure netlify.toml uses `[context.production.environment]` not `[build.environment]`

### Issue: Local dev shows localhost URLs

**Cause**: No environment variables set, falling back incorrectly

**Fix**: This is actually correct behavior now - local should use production URLs

### Issue: RSS feed shows wrong URLs

**Cause**: RSS feed not using `context.site` correctly

**Fix**: RSS feed should use `context.site` which comes from astro.config.mjs

### Issue: Sitemap shows wrong URLs

**Cause**: Sitemap uses `site` from astro.config.mjs

**Fix**: Verify environment variables are set correctly in Netlify

---

## Expected Behavior Summary

‚úÖ **Local dev builds will show production URLs** (`https://pwv.com`)
  - This is intentional and correct
  - Ensures HTML matches production
  - Override with `URL=http://localhost:4321 pnpm run dev` if needed

‚úÖ **Deploy previews will show preview URLs** (e.g., `https://deploy-preview-123--pwv.netlify.app`)
  - Allows testing in isolation
  - Links work correctly in preview environment
  - Canonical URLs point to preview for correct testing

‚úÖ **Production will show production URLs** (`https://pwv.com`)
  - Canonical URLs correct for SEO
  - Sitemap contains production URLs
  - RSS feed contains production URLs
  - Google respects canonical tags

---

## Why This Approach?

### Benefits

1. **SEO-Correct**: Production URLs are always `https://pwv.com`
2. **Preview-Friendly**: Deploy previews work correctly with isolated URLs
3. **Local Testing**: Local builds match production exactly
4. **No Localhost Leaks**: No risk of localhost URLs making it to production
5. **Google-Compatible**: Canonical URLs Google expects and respects

### Trade-offs

- Local dev shows production URLs (not localhost)
- Local testing requires understanding that URLs are production-ready
- Can override with environment variable if localhost testing needed

This is the industry standard approach used by most Astro and Next.js sites.
