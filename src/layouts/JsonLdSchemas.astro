---
import {
  generateOrganizationSchema,
  generatePersonSchema,
  generateWebSiteSchema,
} from '../lib/schema';
import { getCollection } from 'astro:content';
import { SITE_NAME, SITE_DESCRIPTION } from '../consts';

interface Props {
  baseURL?: string | URL;
  canonicalURL: URL;
}

const { baseURL, canonicalURL } = Astro.props;

// Get team members for schema generation
const teamMembers = await getCollection('team' as any);
const generalPartners = (teamMembers as any[])
  .filter((member: any) => member.data.isGeneralPartner)
  .sort((a: any, b: any) => a.data.position - b.data.position);

// Collect organization social media profiles from general partners
const organizationSocialProfiles: string[] = [];
const seenProfiles = new Set<string>();

generalPartners.forEach((member: any) => {
  // Collect Twitter/X profiles
  if (
    member.data.twitter &&
    !seenProfiles.has(`twitter-${member.data.twitter}`)
  ) {
    organizationSocialProfiles.push(`https://x.com/${member.data.twitter}`);
    seenProfiles.add(`twitter-${member.data.twitter}`);
  }
  // Collect LinkedIn profiles
  if (
    member.data.linkedin &&
    !seenProfiles.has(`linkedin-${member.data.linkedin}`)
  ) {
    organizationSocialProfiles.push(
      `https://www.linkedin.com/in/${member.data.linkedin}`
    );
    seenProfiles.add(`linkedin-${member.data.linkedin}`);
  }
});

// Generate Organization schema
const organizationSchema = generateOrganizationSchema({
  name: SITE_NAME,
  url: baseURL?.toString() || canonicalURL.toString(),
  description: SITE_DESCRIPTION,
  // Using PWV logo PNG for better SEO and compatibility
  logo: new URL(
    '/logos/pwv-logo-black-1920.png',
    baseURL || canonicalURL
  ).toString(),
  email: 'partners@pwv.com',
  // Removed contactType - 'customer service' is not appropriate for a VC firm
  founders: generalPartners.map((member: any) => ({
    name: member.data.name,
    url: member.data.website
      ? member.data.website
      : new URL(
          `/about#${member.data.slug}`,
          baseURL || canonicalURL
        ).toString(),
  })),
  sameAs:
    organizationSocialProfiles.length > 0
      ? organizationSocialProfiles
      : undefined,
  // Use InvestmentCompany type for venture capital fund
  type: 'InvestmentCompany',
});

// Generate Person schemas for General Partners
const personSchemas = generalPartners.map((member: any) => {
  const sameAs: string[] = [];
  if (member.data.linkedin) {
    sameAs.push(`https://www.linkedin.com/in/${member.data.linkedin}`);
  }
  if (member.data.twitter) {
    sameAs.push(`https://x.com/${member.data.twitter}`);
  }
  if (member.data.github) {
    sameAs.push(`https://github.com/${member.data.github}`);
  }
  if (member.data.bluesky) {
    // Handle both Bluesky handles and custom domains
    const blueskyUrl = member.data.bluesky.startsWith('http')
      ? member.data.bluesky
      : `https://bsky.app/profile/${member.data.bluesky}`;
    sameAs.push(blueskyUrl);
  }

  return generatePersonSchema({
    name: member.data.name,
    jobTitle: member.data.title,
    description: member.data.bio,
    url: member.data.website
      ? member.data.website
      : new URL(
          `/about#${member.data.slug}`,
          baseURL || canonicalURL
        ).toString(),
    sameAs: sameAs.length > 0 ? sameAs : undefined,
    worksFor: {
      name: SITE_NAME,
      url: baseURL?.toString() || canonicalURL.toString(),
    },
  });
});

// Generate WebSite schema with SearchAction
const siteUrl = baseURL?.toString() || canonicalURL.toString();
const websiteSchema = generateWebSiteSchema({
  name: SITE_NAME,
  url: siteUrl,
  description: SITE_DESCRIPTION,
  potentialAction: {
    target: `${siteUrl}/news?q={search_term_string}`,
    queryInput: 'required name=search_term_string',
  },
});
---

<!-- WebSite JSON-LD Schema with SearchAction -->
<script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

<!-- Organization JSON-LD Schema -->
<script
  type="application/ld+json"
  set:html={JSON.stringify(organizationSchema)}
/>

<!-- Person JSON-LD Schemas for General Partners -->{
  personSchemas.map((schema) => (
    <script type="application/ld+json" set:html={JSON.stringify(schema)} />
  ))
}
