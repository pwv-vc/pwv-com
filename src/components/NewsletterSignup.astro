---
// Mailchimp newsletter signup component
// Uses embedded form approach with environment variables

const MAILCHIMP_U = import.meta.env.PUBLIC_MAILCHIMP_U || '706ed7db916d9dfc1dc8fd3fd';
const MAILCHIMP_ID = import.meta.env.PUBLIC_MAILCHIMP_ID || 'c7e71ef004';
const MAILCHIMP_F_ID = import.meta.env.PUBLIC_MAILCHIMP_F_ID || '00ab1de0f0';
const MAILCHIMP_DATACENTER = import.meta.env.PUBLIC_MAILCHIMP_DATACENTER || 'us7';

interface Props {
  variant?: 'default' | 'inline' | 'compact';
  showHeading?: boolean;
  headingText?: string;
  descriptionText?: string;
  showLearnMore?: boolean;
}

const {
  variant = 'default',
  showHeading = true,
  headingText = 'Stay Updated',
  descriptionText = 'Get the latest news and insights from PWV delivered to your inbox.',
  showLearnMore = true,
} = Astro.props;

// Construct the form action URL
// Format: https://{datacenter}.list-manage.com/subscribe/post?u={user_id}&id={audience_id}&f_id={form_id}
const formAction = `https://pwv.${MAILCHIMP_DATACENTER}.list-manage.com/subscribe/post?u=${MAILCHIMP_U}&id=${MAILCHIMP_ID}&f_id=${MAILCHIMP_F_ID}`;

// Honeypot field name
const honeypotField = `b_${MAILCHIMP_U}_${MAILCHIMP_ID}`;

const isCompact = variant === 'compact';
const isInline = variant === 'inline';
---

<div class={`newsletter-signup max-w-2xl mx-auto bg-pwv-soft-yellow/50 rounded-lg p-6 md:p-8 ${isCompact ? 'newsletter-compact' : ''} ${isInline ? 'newsletter-inline' : ''}`}>
  {showHeading && !isCompact && (
    <h3 class="text-pwv-black mb-3 text-2xl font-semibold leading-tight">
      {headingText}
    </h3>
  )}
  
  {!isCompact && (
    <p class="text-pwv-black/70 mb-6 text-base leading-relaxed">
      {descriptionText}
      {showLearnMore && Astro.url.pathname !== '/newsletter' && (
        <>
          {' '}
          <a href="/newsletter" class="pwv-link-underline">
            Learn more
          </a>
        </>
      )}
    </p>
  )}

  <!-- Begin Mailchimp Signup Form -->
  <div id="mc_embed_signup">
    <form
      action={formAction}
      method="post"
      id="mc-embedded-subscribe-form"
      name="mc-embedded-subscribe-form"
      class="validate"
      target="_blank"
    >
      <div id="mc_embed_signup_scroll" class={isInline ? 'flex flex-col gap-4 md:flex-row md:items-start' : 'flex flex-col gap-4'}>
        <div class={isInline ? 'md:flex-1 flex flex-col gap-4' : 'flex flex-col gap-4'}>
          <div class="mc-field-group">
            {!isCompact && (
              <label for="mce-EMAIL" class="text-pwv-black mb-2 block text-base font-medium">
                Email Address <span class="text-red-500">*</span>
              </label>
            )}
            <input
              type="email"
              name="EMAIL"
              class="required email w-full rounded-lg border border-pwv-gray bg-white px-4 py-3 text-base focus:border-pwv-green focus:outline-none focus:ring-2 focus:ring-pwv-green"
              id="mce-EMAIL"
              required
              placeholder={isCompact ? 'your work email' : 'your work email'}
              value=""
            />
          </div>

          {/* GDPR Consent - Always shown and required */}
          <div id="mergeRow-gdpr" class="mc-field-group">
            <div class={`text-pwv-black/70 space-y-3 ${isCompact ? 'text-xs' : 'text-sm'}`}>
              <label class={`flex items-start cursor-pointer leading-relaxed ${isCompact ? 'gap-2' : 'gap-3'}`}>
                <input
                  type="checkbox"
                  id="gdpr_26464"
                  name="gdpr[26464]"
                  value="Y"
                  class={`rounded border-pwv-gray focus:ring-pwv-green flex-shrink-0 ${isCompact ? 'mt-0.5 w-3.5 h-3.5' : 'mt-1 w-4 h-4'}`}
                  required
                />
                <span class="flex-1">
                  I consent to receiving email updates and communications from PWV. I understand I can unsubscribe at any time. <span class="text-red-500">*</span>
                </span>
              </label>
              {!isCompact && (
                <p class="text-pwv-black/60 text-sm leading-relaxed">
                  We use Mailchimp as our marketing platform. By subscribing, you acknowledge that your information will be transferred to Mailchimp for processing. <a href="https://mailchimp.com/legal/terms" class="pwv-link-underline" target="_blank" rel="noopener noreferrer">Learn more</a>
                </p>
              )}
            </div>
          </div>
        </div>
        
        <!-- Hidden fields for tracking source and tags -->
        <input type="hidden" name="SIGNUP" value="PWV Newsletter Signup" />
        <!-- Add tag IDs here when ready: <input type="hidden" name="tags" value="TAG_ID_1,TAG_ID_2" /> -->
        
        <!-- Real people should not fill this in and expect good things -->
        <div style="position: absolute; left: -5000px;" aria-hidden="true">
          <input
            type="text"
            name={honeypotField}
            tabindex="-1"
            value=""
          />
        </div>

        <!-- Response messages -->
        <div id="mce-responses" class="clear">
          <div class="response" id="mce-error-response" style="display: none;"></div>
          <div class="response" id="mce-success-response" style="display: none;"></div>
        </div>

        <div class={isInline ? 'md:pt-7' : ''}>
          <input
            type="submit"
            value="Subscribe"
            name="subscribe"
            id="mc-embedded-subscribe"
            class="bg-pwv-black text-pwv-white hover:bg-pwv-green hover:text-pwv-black cursor-pointer rounded-lg px-8 py-3 text-base font-medium transition-colors duration-200 w-full md:w-auto"
          />
        </div>
      </div>
    </form>
  </div>
  <!-- End Mailchimp Signup Form -->

  {!isCompact && (
    <p class="text-pwv-black/60 mt-4 text-sm leading-relaxed">
      We respect your privacy. Unsubscribe at any time.
    </p>
  )}
</div>

<style>
  /* Override any Mailchimp default styles if needed */
  #mc_embed_signup {
    background: transparent;
    clear: left;
    width: 100%;
  }

  #mc_embed_signup form {
    padding: 0;
    margin: 0;
  }

  /* Remove Mailchimp branding styles */
  #mc_embed_signup .brandingLogo {
    display: none;
  }

  /* Ensure responsive behavior */
  .newsletter-compact {
    max-width: 100%;
  }

  .newsletter-inline {
    max-width: 100%;
  }

  @media (min-width: 768px) {
    .newsletter-inline #mc_embed_signup_scroll {
      flex-direction: row;
    }
  }
</style>
