---
import { getCollection } from 'astro:content';
import type { TimelineEvent } from './types';

interface Props {
  slug: string;
}

const { slug } = Astro.props;

// Get all individual events for this year
const allEvents = await getCollection('events');
const events = allEvents
  .map((entry) => entry.data)
  .sort((a, b) => a.date.getTime() - b.date.getTime());

// Calculate statistics based on actual data
const totalEvents = events.length;

// Companies engaged - count unique companies from event data
const uniqueCompanies = new Set<string>();
events.forEach((event) => {
  // Add from single company field
  if (event.company) {
    uniqueCompanies.add(event.company);
  }
  // Add from companies array field
  if (event.companies) {
    event.companies.forEach((company) => {
      uniqueCompanies.add(company);
    });
  }
});
const companiesEngaged = uniqueCompanies.size;

// Markets activated - count unique locations (excluding Virtual)
const uniqueLocations = new Set<string>();
events.forEach((event) => {
  if (event.location && event.location !== 'Virtual') {
    uniqueLocations.add(event.location);
  }
});
const marketsActivated = uniqueLocations.size;

// Category counts
const categoryCounts = new Map<string, number>();
events.forEach((event) => {
  if (event.category) {
    event.category.forEach((cat) => {
      categoryCounts.set(cat, (categoryCounts.get(cat) || 0) + 1);
    });
  }
});

const raiseCount = categoryCounts.get('raise') || 0;
const meetupCount = categoryCounts.get('meetup') || 0;
const eventCount = categoryCounts.get('event') || 0;
const announcementCount = categoryCounts.get('announcement') || 0;

// Convening format counts
let virtualCount = 0;
let inPersonCount = 0;

events.forEach((event) => {
  if (event.location) {
    if (event.location === 'Virtual') {
      virtualCount++;
    } else {
      inPersonCount++;
    }
  }
});

// Top locations - just the list without counts
const topLocations = [
  'San Francisco, CA',
  'Boston, MA',
  'Austin, TX',
  'London, UK',
  'Berlin, DE',
];

// Round counts
const seedCount = categoryCounts.get('seed') || 0;
const seriesACount = categoryCounts.get('series-a') || 0;
const seriesBCount = categoryCounts.get('series-b') || 0;
const seriesCCount = categoryCounts.get('series-c') || 0;
const seriesDCount = categoryCounts.get('series-d') || 0;
---

<div class="mx-auto my-12 max-w-6xl px-4">
  <div class="mb-8 text-center">
    <h2 class="text-pwv-black mb-2 font-serif text-3xl font-medium lg:text-4xl">
      2025 Year in Review: By the Numbers
    </h2>
    <p class="text-lg text-gray-700">
      A data-driven look at PWV's activity throughout the year
    </p>
  </div>

  <!-- Main Stats Grid -->
  <div class="mb-8 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4">
    <!-- Total Events -->
    <div
      class="border-pwv-black bg-pwv-light-green rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">{totalEvents}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Total Events
      </div>
      <div class="mt-1 text-sm text-gray-700">
        Organized events PWV participated in or hosted across the ecosystem
      </div>
    </div>

    <!-- Companies Engaged -->
    <div
      class="border-pwv-black bg-pwv-light-teal rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">
        {companiesEngaged}
      </div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Companies Engaged
      </div>
      <div class="mt-1 text-sm text-gray-700">
        Companies PWV engaged with through direct, substantive interaction
      </div>
    </div>

    <!-- Markets Activated -->
    <div
      class="border-pwv-black bg-pwv-light-yellow rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">
        {marketsActivated}
      </div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Markets Activated
      </div>
      <div class="mt-1 text-sm text-gray-700">
        Ecosystems where PWV spent time building founder and partner
        relationships
      </div>
    </div>

    <!-- Funding Rounds -->
    <div
      class="border-pwv-black bg-pwv-soft-green rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">{raiseCount}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Funding Rounds
      </div>
      <div class="mt-1 text-sm text-gray-700">
        Portfolio and ecosystem company raises announced during the year
      </div>
    </div>
  </div>

  <!-- Activity Breakdown -->
  <div class="mb-8 grid grid-cols-1 gap-4 md:grid-cols-3">
    <div
      class="border-pwv-black bg-pwv-light-periwinkle rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-4xl font-bold">{meetupCount}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Founder & Operator 1:1s
      </div>
      <div class="mt-1 text-sm text-gray-700">
        Direct conversations with founders and operators across stages
      </div>
    </div>

    <div
      class="border-pwv-black bg-pwv-light-yellow rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-4xl font-bold">{eventCount}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Community Convenings
      </div>
      <div class="mt-1 text-sm text-gray-700">
        Curated gatherings bringing founders, operators, and partners together
      </div>
    </div>

    <div
      class="border-pwv-black bg-pwv-light-green rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-4xl font-bold">
        {announcementCount}
      </div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Announcements
      </div>
      <div class="mt-1 text-sm text-gray-700">
        Major fund, portfolio, and community milestones shared publicly
      </div>
    </div>
  </div>

  <!-- Location & Virtual Stats -->
  <div class="mb-8 grid grid-cols-1 gap-4 lg:grid-cols-2">
    <!-- Virtual vs In-Person -->
    <div
      class="border-pwv-black bg-pwv-light-coral rounded-lg border-2 p-6 shadow-sm"
    >
      <h3 class="text-pwv-black mb-4 font-serif text-xl font-medium">
        Convening Format
      </h3>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <span class="text-gray-700">In-Person</span>
          <span class="text-pwv-black text-2xl font-bold">{inPersonCount}</span>
        </div>
        <div class="h-2 w-full rounded-full bg-gray-200">
          <div
            class="bg-pwv-green h-2 rounded-full"
            style={`width: ${(inPersonCount / (inPersonCount + virtualCount)) * 100}%`}
          >
          </div>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-gray-700">Virtual</span>
          <span class="text-pwv-black text-2xl font-bold">{virtualCount}</span>
        </div>
        <div class="h-2 w-full rounded-full bg-gray-200">
          <div
            class="bg-pwv-teal h-2 rounded-full"
            style={`width: ${(virtualCount / (inPersonCount + virtualCount)) * 100}%`}
          >
          </div>
        </div>
      </div>
    </div>

    <!-- Top Locations -->
    <div
      class="border-pwv-black bg-pwv-light-lavender rounded-lg border-2 p-6 shadow-sm"
    >
      <h3 class="text-pwv-black mb-4 font-serif text-xl font-medium">
        Top Locations
      </h3>
      <div class="space-y-2">
        {
          topLocations.map((location) => (
            <div class="text-gray-700">{location}</div>
          ))
        }
      </div>
    </div>
  </div>

  <!-- Funding Round Breakdown -->
  {
    raiseCount > 0 && (
      <div class="border-pwv-black mb-8 rounded-lg border-2 bg-white p-6 shadow-sm">
        <h3 class="text-pwv-black mb-4 font-serif text-xl font-medium">
          Funding Round Breakdown
        </h3>
        <p>
          Our existing portfolio announced {raiseCount} follow-on funding rounds
          in 2025.
        </p>
        <div class="grid grid-cols-2 gap-4 md:grid-cols-5">
          {seedCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seedCount}
              </div>
              <div class="bg-pwv-light-green text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Seed
              </div>
            </div>
          )}
          {seriesACount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesACount}
              </div>
              <div class="bg-pwv-light-teal text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series A
              </div>
            </div>
          )}
          {seriesBCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesBCount}
              </div>
              <div class="bg-pwv-soft-teal text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series B
              </div>
            </div>
          )}
          {seriesCCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesCCount}
              </div>
              <div class="bg-pwv-light-periwinkle text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series C
              </div>
            </div>
          )}
          {seriesDCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesDCount}
              </div>
              <div class="bg-pwv-light-lavender text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series D
              </div>
            </div>
          )}
        </div>
      </div>
    )
  }
</div>
