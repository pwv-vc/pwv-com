---
import type { TimelineEvent } from './types';

interface Props {
  events: TimelineEvent[];
}

const { events } = Astro.props;

// Calculate statistics
const totalEvents = events.length;

// Companies mentioned (extract from titles and descriptions)
const companyMentions = new Set<string>();
const companyPattern = /\b([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)\b/g;

events.forEach((event) => {
  // Extract company names from titles (before special characters)
  const titleMatch = event.title.match(/^([^<>:\[\]]+)/);
  if (titleMatch) {
    const potentialCompany = titleMatch[1].trim();
    // Filter out common words and keep likely company names
    if (
      potentialCompany.length > 2 &&
      !potentialCompany.match(/^(Meeting|Event|PWV|Join|Hosted|Virtual)/)
    ) {
      const cleanName = potentialCompany
        .replace(/\s+(raises|announces|closes|<>|and|from|with)\s+.*/i, '')
        .trim();
      if (cleanName && cleanName.length > 2) {
        companyMentions.add(cleanName);
      }
    }
  }
});

const uniqueCompanies = Array.from(companyMentions).sort();

// Locations
const locationCounts = new Map<string, number>();
let virtualCount = 0;
let inPersonCount = 0;

events.forEach((event) => {
  if (event.location) {
    if (
      event.location.toLowerCase().includes('virtual') ||
      event.location.toLowerCase().includes('zoom')
    ) {
      virtualCount++;
    } else {
      inPersonCount++;
      locationCounts.set(
        event.location,
        (locationCounts.get(event.location) || 0) + 1
      );
    }
  }
});

const topLocations = Array.from(locationCounts.entries())
  .sort((a, b) => b[1] - a[1])
  .slice(0, 5);

// Category counts
const categoryCounts = new Map<string, number>();
events.forEach((event) => {
  if (event.category) {
    event.category.forEach((cat) => {
      categoryCounts.set(cat, (categoryCounts.get(cat) || 0) + 1);
    });
  }
});

const raiseCount = categoryCounts.get('raise') || 0;
const meetupCount = categoryCounts.get('meetup') || 0;
const eventCount = categoryCounts.get('event') || 0;
const announcementCount = categoryCounts.get('announcement') || 0;

// Round counts
const seedCount = categoryCounts.get('seed') || 0;
const seriesACount = categoryCounts.get('series-a') || 0;
const seriesBCount = categoryCounts.get('series-b') || 0;
const seriesCCount = categoryCounts.get('series-c') || 0;
const seriesDCount = categoryCounts.get('series-d') || 0;
---

<div class="mx-auto my-12 max-w-6xl px-4">
  <div class="mb-8 text-center">
    <h2 class="text-pwv-black mb-2 font-serif text-3xl font-medium lg:text-4xl">
      2025 Year in Review: By the Numbers
    </h2>
    <p class="text-lg text-gray-700">
      A data-driven look at PWV's activity throughout the year
    </p>
  </div>

  <!-- Main Stats Grid -->
  <div class="mb-8 grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-4">
    <!-- Total Events -->
    <div
      class="border-pwv-black bg-pwv-light-green rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">{totalEvents}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Total Events
      </div>
      <div class="mt-1 text-sm text-gray-700">Milestones tracked this year</div>
    </div>

    <!-- Companies -->
    <div
      class="border-pwv-black bg-pwv-light-teal rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">
        {uniqueCompanies.length}
      </div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Companies Mentioned
      </div>
      <div class="mt-1 text-sm text-gray-700">Across all activities</div>
    </div>

    <!-- Locations -->
    <div
      class="border-pwv-black bg-pwv-light-yellow rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">
        {locationCounts.size}
      </div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Unique Locations
      </div>
      <div class="mt-1 text-sm text-gray-700">Cities and venues visited</div>
    </div>

    <!-- Raises -->
    <div
      class="border-pwv-black bg-pwv-soft-green rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-5xl font-bold">{raiseCount}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Funding Rounds
      </div>
      <div class="mt-1 text-sm text-gray-700">Portfolio company raises</div>
    </div>
  </div>

  <!-- Activity Breakdown -->
  <div class="mb-8 grid grid-cols-1 gap-4 md:grid-cols-3">
    <div
      class="border-pwv-black bg-pwv-light-periwinkle rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-4xl font-bold">{meetupCount}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">Meetups</div>
      <div class="mt-1 text-sm text-gray-700">
        One-on-one founder connections
      </div>
    </div>

    <div
      class="border-pwv-black bg-pwv-light-yellow rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-4xl font-bold">{eventCount}</div>
      <div class="text-pwv-black font-serif text-lg font-medium">Events</div>
      <div class="mt-1 text-sm text-gray-700">Community gatherings hosted</div>
    </div>

    <div
      class="border-pwv-black bg-pwv-light-green rounded-lg border-2 p-6 shadow-sm"
    >
      <div class="text-pwv-black mb-2 text-4xl font-bold">
        {announcementCount}
      </div>
      <div class="text-pwv-black font-serif text-lg font-medium">
        Announcements
      </div>
      <div class="mt-1 text-sm text-gray-700">Major milestones shared</div>
    </div>
  </div>

  <!-- Location & Virtual Stats -->
  <div class="mb-8 grid grid-cols-1 gap-4 lg:grid-cols-2">
    <!-- Virtual vs In-Person -->
    <div
      class="border-pwv-black bg-pwv-light-coral rounded-lg border-2 p-6 shadow-sm"
    >
      <h3 class="text-pwv-black mb-4 font-serif text-xl font-medium">
        Meeting Format
      </h3>
      <div class="space-y-3">
        <div class="flex items-center justify-between">
          <span class="text-gray-700">In-Person</span>
          <span class="text-pwv-black text-2xl font-bold">{inPersonCount}</span>
        </div>
        <div class="h-2 w-full rounded-full bg-gray-200">
          <div
            class="bg-pwv-green h-2 rounded-full"
            style={`width: ${(inPersonCount / (inPersonCount + virtualCount)) * 100}%`}
          >
          </div>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-gray-700">Virtual</span>
          <span class="text-pwv-black text-2xl font-bold">{virtualCount}</span>
        </div>
        <div class="h-2 w-full rounded-full bg-gray-200">
          <div
            class="bg-pwv-teal h-2 rounded-full"
            style={`width: ${(virtualCount / (inPersonCount + virtualCount)) * 100}%`}
          >
          </div>
        </div>
      </div>
    </div>

    <!-- Top Locations -->
    <div
      class="border-pwv-black bg-pwv-light-lavender rounded-lg border-2 p-6 shadow-sm"
    >
      <h3 class="text-pwv-black mb-4 font-serif text-xl font-medium">
        Top Locations
      </h3>
      <div class="space-y-3">
        {
          topLocations.map(([location, count]) => (
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-700">{location}</span>
              <span class="text-pwv-black font-mono text-lg font-bold">
                {count}
              </span>
            </div>
          ))
        }
      </div>
    </div>
  </div>

  <!-- Funding Round Breakdown -->
  {
    raiseCount > 0 && (
      <div class="border-pwv-black mb-8 rounded-lg border-2 bg-white p-6 shadow-sm">
        <h3 class="text-pwv-black mb-4 font-serif text-xl font-medium">
          Funding Round Breakdown
        </h3>
        <div class="grid grid-cols-2 gap-4 md:grid-cols-5">
          {seedCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seedCount}
              </div>
              <div class="bg-pwv-light-green text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Seed
              </div>
            </div>
          )}
          {seriesACount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesACount}
              </div>
              <div class="bg-pwv-light-teal text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series A
              </div>
            </div>
          )}
          {seriesBCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesBCount}
              </div>
              <div class="bg-pwv-soft-teal text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series B
              </div>
            </div>
          )}
          {seriesCCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesCCount}
              </div>
              <div class="bg-pwv-light-periwinkle text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series C
              </div>
            </div>
          )}
          {seriesDCount > 0 && (
            <div class="text-center">
              <div class="text-pwv-black mb-1 text-3xl font-bold">
                {seriesDCount}
              </div>
              <div class="bg-pwv-light-lavender text-pwv-black rounded-full px-3 py-1 text-sm font-medium">
                Series D
              </div>
            </div>
          )}
        </div>
      </div>
    )
  }

  <!-- Companies List -->
  <div
    class="border-pwv-black bg-pwv-light-periwinkle rounded-lg border-2 p-6 shadow-sm"
  >
    <h3 class="text-pwv-black mb-4 font-serif text-xl font-medium">Featured</h3>
    <div class="flex flex-wrap gap-2">
      {
        uniqueCompanies
          .slice(0, 20)
          .map((company) => (
            <span class="border-pwv-black text-pwv-black rounded-full border bg-white px-3 py-1 text-sm font-medium">
              {company}
            </span>
          ))
      }
      {
        uniqueCompanies.length > 20 && (
          <span class="border-pwv-black bg-pwv-gray text-pwv-black rounded-full border px-3 py-1 text-sm font-medium">
            +{uniqueCompanies.length - 20} more
          </span>
        )
      }
    </div>
  </div>
</div>
