---
import { getCollection } from 'astro:content';
import { resolveImageSrc } from '../../lib/images';
import EntityCard from './EntityCard.astro';
import EntityHeader from './EntityHeader.astro';
import ShareButtons from './ShareButtons.astro';
import RelatedPosts from './RelatedPosts.astro';

interface Props {
  name: string;
  mentions: number;
  posts: string[];
  borderColor: string;
  portfolioSlug?: string;
  url?: string;
}

const { name, mentions, posts, borderColor, portfolioSlug, url } = Astro.props;

// Create share URL and text
const siteUrl = Astro.site || 'https://pwv.com';
const shareUrl = url || new URL('/explore/companies/', siteUrl).toString();
const shareText = `${name} - Featured in ${posts.length} PWV post${posts.length === 1 ? '' : 's'}`;

// Load post data to get titles, hero images, and dates
const allPosts = await getCollection('posts');
const postData = posts.map(postSlug => {
  const post = allPosts.find(p => p.id === postSlug);
  return post ? {
    slug: postSlug,
    title: post.data.title,
    heroImage: post.data.heroImage,
    pubDate: post.data.pubDate,
  } : null;
}).filter(Boolean);

// Sort by publication date (newest first)
postData.sort((a, b) => {
  const dateA = a.pubDate ? new Date(a.pubDate).getTime() : 0;
  const dateB = b.pubDate ? new Date(b.pubDate).getTime() : 0;
  return dateB - dateA;
});

// Helper to get a slug-friendly version of company name for logo lookup
const getCompanySlug = (companyName: string) => {
  return companyName.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
};

const slug = portfolioSlug || getCompanySlug(name);
let logoSrc: string | null = null;

try {
  logoSrc = resolveImageSrc(`logos/small/${slug}.png`);
} catch (e) {
  // No logo available, will show fallback
}
---

<EntityCard borderColor={borderColor}>
  <div class="flex flex-col gap-4 h-full">
    <div class="flex-1 flex flex-col gap-4">
      <!-- Company Header -->
      <EntityHeader 
        type="company"
        name={name}
        imageSrc={logoSrc}
        url={url}
        borderColor={borderColor}
      />

      <!-- Related Posts -->
      <RelatedPosts posts={postData} borderColor={borderColor} />
    </div>

    <!-- Share Buttons (always at bottom) -->
    <ShareButtons 
      shareUrl={shareUrl}
      shareText={shareText}
      shareType="company"
    />
  </div>
</EntityCard>
