---
import { getCollection } from 'astro:content';
import EntityCard from './EntityCard.astro';
import ShareButtons from './ShareButtons.astro';
import RelatedPosts from './RelatedPosts.astro';

interface Props {
  topic: string;
  postSlugs: string[];
  borderColor: string;
}

const { topic, postSlugs, borderColor } = Astro.props;

// Create share URL and text - link to the topic detail page on PWV
const siteUrl = Astro.site || 'https://pwv.com';
const topicSlug = topic.toLowerCase().replace(/\s+/g, '-').replace(/[^\w-]/g, '');
const detailPageUrl = `/showcase/topics/${topicSlug}/`;
const shareUrl = new URL(detailPageUrl, siteUrl).toString();
const shareText = `${topic} - Featured in ${postSlugs.length} PWV post${postSlugs.length === 1 ? '' : 's'}`;

// Load post data to get titles, hero images, and dates
const allPosts = await getCollection('posts');
const postData = postSlugs.map(postSlug => {
  const post = allPosts.find(p => p.id === postSlug);
  return post ? {
    slug: postSlug,
    title: post.data.title,
    heroImage: post.data.heroImage,
    pubDate: post.data.pubDate,
  } : null;
}).filter(Boolean);

// Sort by publication date (newest first)
postData.sort((a, b) => {
  const dateA = a.pubDate ? new Date(a.pubDate).getTime() : 0;
  const dateB = b.pubDate ? new Date(b.pubDate).getTime() : 0;
  return dateB - dateA;
});
---

<EntityCard borderColor={borderColor}>
  <div class="flex flex-col gap-4 h-full">
    <div class="flex-1 flex flex-col gap-4">
      <!-- Topic Header -->
      <div class={`-m-6 mb-0 p-4 rounded-t-lg bg-${borderColor}/20`}>
        <div class="flex items-center gap-3">
          <div class="flex-shrink-0 text-pwv-black">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
            </svg>
          </div>
          <h3 class="font-serif text-xl font-medium break-words flex-1">{topic}</h3>
        </div>
      </div>

      <!-- Related Posts -->
      <RelatedPosts posts={postData} borderColor={borderColor} />
    </div>

    <!-- Share Buttons (always at bottom) -->
    <ShareButtons 
      shareUrl={shareUrl}
      shareText={shareText}
      shareType="topic"
      detailPageUrl={detailPageUrl}
    />
  </div>
</EntityCard>
