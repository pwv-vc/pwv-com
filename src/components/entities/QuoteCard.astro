---
import { getCollection } from 'astro:content';
import EntityCard from './EntityCard.astro';
import ShareButtons from './ShareButtons.astro';
import RelatedPosts from './RelatedPosts.astro';

interface Props {
  quote: string;
  speaker: string;
  context?: string;
  postSlug: string;
  postTitle: string;
  pubDate?: string;
  borderColor: string;
  quoteIndex?: number;
}

const { quote, speaker, context, postSlug, postTitle, pubDate, borderColor, quoteIndex = 0 } = Astro.props;

// Create share URL and text - link to the quote detail page on PWV
const siteUrl = Astro.site || 'https://pwv.com';
const quoteId = `${postSlug}-${quoteIndex}`;
const detailPageUrl = `/amplify/quotes/${quoteId}/`;
const shareUrl = new URL(detailPageUrl, siteUrl).toString();
const shareText = `"${quote}" — ${speaker}`;

// Load post data to get hero image and date
const allPosts = await getCollection('posts');
const post = allPosts.find(p => p.id === postSlug);

// Format as array for RelatedPosts component
const postData = post ? [{
  slug: postSlug,
  title: post.data.title,
  heroImage: post.data.heroImage,
  pubDate: post.data.pubDate,
}] : [];
---

<EntityCard borderColor={borderColor}>
  <div class="flex flex-col gap-4 h-full">
    <div class="flex-1 flex flex-col gap-4">
      <!-- Quote Text -->
      <blockquote class={`-m-6 mb-0 p-6 rounded-t-lg bg-${borderColor}/10`}>
      <p class="font-serif text-lg leading-relaxed italic text-pwv-black">
        "{quote}"
      </p>
    </blockquote>

    <!-- Speaker -->
    <div class={`px-4 py-3 rounded-lg bg-${borderColor}/15`}>
      <p class="text-pwv-black">— {speaker}</p>
      {context && (
        <p class="text-sm text-pwv-black/70 mt-1">{context}</p>
      )}
    </div>

      <!-- Source Post -->
      <RelatedPosts posts={postData} borderColor={borderColor} maxDisplay={1} />
    </div>

    <!-- Share Buttons (always at bottom) -->
    <ShareButtons 
      shareUrl={shareUrl}
      shareText={shareText}
      shareType="quote"
      detailPageUrl={detailPageUrl}
    />
  </div>
</EntityCard>
