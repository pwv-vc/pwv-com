---
import { getCollection } from 'astro:content';
import EntityCard from './EntityCard.astro';
import ShareButtons from './ShareButtons.astro';
import RelatedPosts from './RelatedPosts.astro';
import DocumentIcon from '../icons/DocumentIcon.astro';
import LightbulbIcon from '../icons/LightbulbIcon.astro';
import TrendingIcon from '../icons/TrendingIcon.astro';
import BookIcon from '../icons/BookIcon.astro';
import SparklesIcon from '../icons/SparklesIcon.astro';
import FlagIcon from '../icons/FlagIcon.astro';
import FundingIcon from '../icons/FundingIcon.astro';
import RocketIcon from '../icons/RocketIcon.astro';
import HandshakeIcon from '../icons/HandshakeIcon.astro';

interface Props {
  fact: string;
  category: string;
  date?: string;
  postSlug: string;
  postTitle: string;
  pubDate?: string;
  borderColor: string;
  factIndex?: number;
}

const { fact, category, date, postSlug, postTitle, pubDate, borderColor, factIndex = 0 } = Astro.props;

// Select icon based on category
const categoryIcons: Record<string, any> = {
  'insight': LightbulbIcon,
  'trend': TrendingIcon,
  'philosophy': BookIcon,
  'announcement': SparklesIcon,
  'milestone': FlagIcon,
  'funding': FundingIcon,
  'launch': RocketIcon,
  'partnership': HandshakeIcon,
};

const CategoryIcon = categoryIcons[category] || DocumentIcon;

// Create share URL and text - link to the fact detail page on PWV
const siteUrl = Astro.site || 'https://pwv.com';
const factId = `${postSlug}-${factIndex}`;
const detailPageUrl = `/showcase/facts/${factId}/`;
const shareUrl = new URL(detailPageUrl, siteUrl).toString();
const shareText = `${fact} [${category}]`;

// Load post data to get hero image and date
const allPosts = await getCollection('posts');
const post = allPosts.find(p => p.id === postSlug);

// Format as array for RelatedPosts component
const postData = post ? [{
  slug: postSlug,
  title: post.data.title,
  heroImage: post.data.heroImage,
  pubDate: post.data.pubDate,
}] : [];

// Category badge colors
const categoryColors: Record<string, string> = {
  'insight': 'pwv-soft-lavender',
  'trend': 'pwv-soft-teal',
  'philosophy': 'pwv-soft-periwinkle',
  'announcement': 'pwv-soft-yellow',
  'milestone': 'pwv-soft-green',
  'funding': 'pwv-soft-coral',
  'launch': 'pwv-soft-yellow',
  'partnership': 'pwv-soft-teal',
};

const categoryColor = categoryColors[category] || 'pwv-soft-periwinkle';
---

<EntityCard borderColor={borderColor}>
  <div class="flex flex-col gap-4 h-full">
    <div class="flex-1 flex flex-col gap-4">
      <!-- Fact Text -->
      <div class={`-m-6 mb-0 p-6 rounded-t-lg bg-${borderColor}/10`}>
        <div class="flex items-start gap-3">
          <div class="flex-shrink-0 text-pwv-black">
            <DocumentIcon class="h-6 w-6" />
          </div>
          <p class="font-serif text-lg leading-relaxed text-pwv-black flex-1">
            {fact}
          </p>
        </div>
      </div>

      <!-- Category and Date -->
      <div class="flex flex-wrap items-center gap-2">
        <span class={`inline-flex items-center gap-1.5 rounded-full bg-${categoryColor}/30 px-3 py-1 text-xs font-medium text-pwv-black`}>
          <CategoryIcon class="h-3.5 w-3.5" />
          <span class="capitalize">{category}</span>
        </span>
        {date && (
          <span class="text-xs text-pwv-black/60">
            {date}
          </span>
        )}
      </div>

      <!-- Source Post -->
      <RelatedPosts posts={postData} borderColor={borderColor} maxDisplay={1} />
    </div>

    <!-- Share Buttons (always at bottom) -->
    <ShareButtons 
      shareUrl={shareUrl}
      shareText={shareText}
      shareType="quote"
      detailPageUrl={detailPageUrl}
    />
  </div>
</EntityCard>
