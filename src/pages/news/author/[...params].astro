---
import Layout from '../../../layouts/Layout.astro';
import Heading1 from '../../../components/Heading1.astro';
import Heading2NoUnderline from '../../../components/Heading2NoUnderline.astro';
import {
  getAllAuthors,
  authorToSlug,
  getAuthorBySlug,
  getPaginatedPostsByAuthor,
} from '../../../lib/news';
import PostsGrid from '../../../components/PostsGrid.astro';
import Pagination from '../../../components/Pagination.astro';

export async function getStaticPaths() {
  const pageSize = 12;
  const authors = await getAllAuthors();
  const paths: Array<{ params: { params: string } }> = [];

  for (const author of authors) {
    const authorSlug = authorToSlug(author);
    const posts = await getPaginatedPostsByAuthor(author, 1, 9999);
    const totalPages = Math.ceil(posts.pagination.totalPosts / pageSize);

    // Generate paths for each page
    for (let page = 1; page <= totalPages; page++) {
      const segments: string[] = [authorSlug];
      if (page > 1) {
        segments.push(page.toString());
      }
      paths.push({ params: { params: segments.join('/') } });
    }
  }

  return paths;
}

// Parse params from the catch-all route
const params = Astro.params.params?.split('/') || [];
const authorSlug = params[0] || '';
const page = params[1] ? parseInt(params[1]) : 1;

// Get the actual author name from slug
const author = await getAuthorBySlug(authorSlug);

if (!author) {
  return Astro.redirect('/news');
}

// Get paginated posts
const pageSize = 12;
const { posts, pagination } = await getPaginatedPostsByAuthor(
  author,
  page,
  pageSize
);

const title = `News by ${author}`;
const description = `Discover perspectives, insights, and announcements by ${author} from PWV and our community.`;
---

<Layout title={title} description={description}>
  <section class="mx-auto">
    <Heading1>News by {author}</Heading1>
    <p class="mb-8 text-lg">
      Articles and posts by {author}.
    </p>

    {
      posts.length > 0 ? (
        <>
          <Heading2NoUnderline>All Posts</Heading2NoUnderline>
          <PostsGrid posts={posts} size="large" />

          <Pagination
            currentPage={pagination.currentPage}
            totalPages={pagination.totalPages}
            baseUrl={`/news/author/${authorSlug}`}
          />
        </>
      ) : (
        <p class="text-lg">No posts found by this author.</p>
      )
    }

    <div class="mt-8 text-center">
      <a
        href="/news"
        class="bg-pwv-black text-pwv-white inline-flex items-center gap-2 rounded-lg px-5 py-2 text-sm"
      >
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>

        Back to News
      </a>
    </div>
  </section>
</Layout>
