---
import Layout from '../../layouts/Layout.astro';
import Heading1 from '../../components/Heading1.astro';
import Heading2NoUnderline from '../../components/Heading2NoUnderline.astro';
import {
  getPaginatedPosts,
  getExternalPosts,
  getNonExternalPosts,
  getAllPosts,
} from '../../lib/news';
import PostsGrid from '../../components/PostsGrid.astro';
import PostsToggle from '../../components/PostsToggle.astro';
import FeaturedPosts from '../../components/FeaturedPosts.astro';
import Pagination from '../../components/Pagination.astro';

export async function getStaticPaths() {
  const pageSize = 12;
  const allPosts = await getAllPosts();
  const totalPages = Math.ceil(allPosts.length / pageSize);
  const paths: Array<{ params: { page: string } }> = [];

  // Generate paths for pages 2 and beyond
  for (let page = 2; page <= totalPages; page++) {
    paths.push({ params: { page: page.toString() } });
  }

  return paths;
}

const page = parseInt(Astro.params.page ?? '1');
const activeFilter: 'all' | 'community' | 'pwv' = 'all';
const postsHeading = 'All Posts';

const pageSize = 12;
const { posts, pagination } = await getPaginatedPosts(
  page,
  pageSize,
  activeFilter
);

const externalPosts = await getExternalPosts();
const nonExternalPosts = await getNonExternalPosts();
const title = 'News';
const description =
  'Perspectives and announcements from PWV, our founders and community.';

// Paginated pages should noindex and have canonical pointing to first page
const shouldNoindex = page > 1;
const canonicalPageURL = page > 1 ? '/news' : undefined;
---

<Layout
  title={title}
  description={description}
  noindex={shouldNoindex}
  canonicalURL={canonicalPageURL}
>
  <section class="mx-auto">
    <Heading1>News</Heading1>
    <p class="mb-8 text-lg">
      Perspectives and announcements from PWV, our founders and community.
    </p>

    <PostsToggle
      externalCount={externalPosts.length}
      nonExternalCount={nonExternalPosts.length}
      activeFilter={activeFilter}
    />

    {activeFilter === 'all' && <FeaturedPosts />}

    <Heading2NoUnderline>{postsHeading}</Heading2NoUnderline>
    <PostsGrid posts={posts} size="large" />

    <Pagination
      currentPage={pagination.currentPage}
      totalPages={pagination.totalPages}
      baseUrl="/news"
      filter={activeFilter}
    />

    <div class="mt-8 text-center">
      <a
        href="/"
        class="bg-pwv-black text-pwv-white inline-flex items-center gap-2 rounded-lg px-5 py-2 text-sm"
      >
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>

        Home
      </a>
    </div>
  </section>
</Layout>

