---
import Layout from '../../layouts/Layout.astro';
import Heading1 from '../../components/Heading1.astro';
import Heading2NoUnderline from '../../components/Heading2NoUnderline.astro';
import {
  getPaginatedPosts,
  getExternalPosts,
  getNonExternalPosts,
} from '../../lib/news';
import PostsGrid from '../../components/PostsGrid.astro';
import PostsToggle from '../../components/PostsToggle.astro';
import FeaturedPosts from '../../components/FeaturedPosts.astro';
import Pagination from '../../components/Pagination.astro';
import NewsletterCTA from '../../components/NewsletterCTA.astro';
import {
  generateBreadcrumbListSchema,
  generateItemListSchema,
} from '../../lib/schema';

// Get base URL for schema generation
export const isProduction = process.env.CONTEXT === 'production';
export const isDeployPreview = process.env.CONTEXT === 'deploy-preview';
const baseURL = isDeployPreview
  ? process.env.DEPLOY_PRIME_URL || Astro.site
  : Astro.site;
const canonicalURL = new URL('/news', baseURL);

// Default page: all filter, page 1
const activeFilter: 'all' | 'community' | 'pwv' = 'all';
const page = 1;

// Derive heading based on active filter
const postsHeading = 'All Posts';

// Get paginated posts
const pageSize = 12;
const { posts, pagination } = await getPaginatedPosts(
  page,
  pageSize,
  activeFilter
);

// Get counts for the toggle
const externalPosts = await getExternalPosts();
const nonExternalPosts = await getNonExternalPosts();
const title = 'News';
const description =
  'Perspectives and announcements from PWV, our founders and community.';

// Generate BreadcrumbList schema
const breadcrumbItems = [
  { name: 'Home', url: new URL('/', baseURL).toString() },
  { name: 'News', url: canonicalURL.toString() },
];
const breadcrumbSchema = generateBreadcrumbListSchema({
  items: breadcrumbItems,
});

// Generate ItemList schema for the posts on this page
const itemListItems = posts.map((post) => {
  const postUrl = new URL(`/news/${post.id}`, baseURL).toString();
  let postImage: string | undefined;

  if (post.data.heroImage) {
    if (typeof post.data.heroImage === 'string') {
      postImage = post.data.heroImage.startsWith('/')
        ? new URL(post.data.heroImage, baseURL).toString()
        : undefined;
    } else if (
      typeof post.data.heroImage === 'object' &&
      post.data.heroImage !== null &&
      'src' in post.data.heroImage
    ) {
      const src = (post.data.heroImage as any).src;
      postImage =
        typeof src === 'string' && src.startsWith('/')
          ? new URL(src, baseURL).toString()
          : undefined;
    }
  }

  return {
    '@type': post.data.url ? 'NewsArticle' : 'BlogPosting',
    name: post.data.title,
    url: postUrl,
    description: post.data.description,
    ...(postImage && { image: postImage }),
    datePublished: post.data.pubDate.toISOString(),
  };
});

const itemListSchema = generateItemListSchema({
  name: 'News Posts',
  description: description,
  url: canonicalURL.toString(),
  items: itemListItems,
  numberOfItems: posts.length,
});
---

<Layout
  title={title}
  description={description}
  additionalSchemas={[{ schema: breadcrumbSchema }, { schema: itemListSchema }]}
>
  <section class="mx-auto">
    <Heading1>News</Heading1>
    <p class="mb-8 text-lg">
      Perspectives and announcements from PWV (Preston-Werner Ventures), our
      founders and community.
    </p>

    <PostsToggle
      externalCount={externalPosts.length}
      nonExternalCount={nonExternalPosts.length}
      activeFilter={activeFilter}
    />

    {activeFilter === 'all' && <FeaturedPosts />}

    <Heading2NoUnderline>{postsHeading}</Heading2NoUnderline>
    <PostsGrid posts={posts} size="large" />

    <Pagination
      currentPage={pagination.currentPage}
      totalPages={pagination.totalPages}
      baseUrl="/news"
      filter={activeFilter}
    />

    <!-- Newsletter CTA -->
    <NewsletterCTA />

    <div class="mt-8 text-center">
      <a
        href="/"
        class="bg-pwv-black text-pwv-white inline-flex items-center gap-2 rounded-lg px-5 py-2 text-sm"
      >
        <svg
          class="h-4 w-4"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M15 19l-7-7 7-7"></path>
        </svg>

        Home
      </a>
    </div>
  </section>
</Layout>
