---
import Heading1 from '../../components/Heading1.astro';
import { type CollectionEntry } from 'astro:content';
import { render } from 'astro:content';
import SmartImage from '../../components/SmartImage.astro';
import Layout from '../../layouts/Layout.astro';
import PlaceholderImage from '../../components/PlaceholderImage.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import PostNavigation from '../../components/PostNavigation.astro';
import {
  getAllPosts,
  getReadingTime,
  getPostNavigation,
  getPostBySlug,
} from '../../lib/news';

// SSR mode - fetch post data directly
const slug = Astro.params.slug;

if (!slug) {
  return Astro.redirect('/404');
}

const post = await getPostBySlug(slug);

if (!post) {
  return Astro.redirect('/404');
}

const { Content } = await render(post);
const { nextPost, previousPost } = await getPostNavigation(post.id);

// Generate meta data from post
const title = post.data.title;
const description = post.data.description;
const image = post.data.heroImage ? post.data.heroImage.src : '/og-image.png';
const keywords = post.data.tags.join(', ');
---

<Layout
  title={title}
  description={description}
  image={image}
  keywords={keywords}
  author={post.data.author}
  pubDate={post.data.pubDate}
  updatedDate={post.data.updatedDate}
  tags={post.data.tags}
  imageAlt={post.data.title}
  locale="en_US"
>
  <div class="prose prose-lg max-w-screen-xl">
    <Heading1>{title}</Heading1>

    <p>
      {post.data.description}
    </p>
    <p class="text-subtle text-sm">
      Posted by {post.data.author} ‚Ä¢ {getReadingTime(post.body)} min read
    </p>
    <div class="mx-auto flex justify-center">
      {
        post.data.heroImage ? (
          <div class="mb-4 h-auto w-full overflow-hidden lg:w-1/2">
            <SmartImage
              src={post.data.heroImage}
              alt={post.data.title}
              size="full"
              rounded={false}
              shadow={false}
              class="h-full w-full"
              loading="eager"
            />
          </div>
        ) : (
          <PlaceholderImage
            alt={`Hero image for ${post.data.title}`}
            class="mb-8 h-64 w-full rounded-lg"
          />
        )
      }
    </div>
    <div class="flex items-center justify-between">
      <div class="flex flex-wrap gap-2">
        {
          post.data.tags.map((tag) => (
            <span class="border-default text-subtle rounded-lg border p-2 font-mono text-sm">
              {tag}
            </span>
          ))
        }
      </div>
      <p class="ml-auto text-sm whitespace-nowrap">
        üóìÔ∏è <FormattedDate date={post.data.pubDate} />
      </p>
    </div>
    <hr />
    <Content />

    <!-- External link for posts with URL -->
    {
      post.data.url && (
        <div class="border-default bg-surface-muted mt-8 rounded-lg border p-6">
          <p class="text-muted mb-3 text-sm">
            This is an external article from our library.
          </p>
          <a
            href={post.data.url}
            target="_blank"
            rel="noopener noreferrer"
            class="bg-primary fg-on-primary hover:bg-primary-hover inline-flex items-center gap-2 rounded-lg px-4 py-2 font-medium transition-colors duration-200"
          >
            Read full article on{' '}
            {new URL(post.data.url).hostname.replace('www.', '')}
            <svg
              class="h-4 w-4"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"
              />
            </svg>
          </a>
        </div>
      )
    }

    <!-- Post Navigation -->
    <PostNavigation
      currentPost={post}
      nextPost={nextPost}
      previousPost={previousPost}
    />
  </div>
</Layout>
