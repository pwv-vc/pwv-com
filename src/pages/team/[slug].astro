---
import Layout from '../../layouts/Layout.astro';
import Heading1 from '../../components/Heading1.astro';
import Heading2NoUnderline from '../../components/Heading2NoUnderline.astro';
import LinkedInLink from '../../components/LinkedInLink.astro';
import TwitterLink from '../../components/TwitterLink.astro';
import GitHubLink from '../../components/GitHubLink.astro';
import BlueskyLink from '../../components/BlueskyLink.astro';
import WebsiteLink from '../../components/WebsiteLink.astro';
import PostsGrid from '../../components/PostsGrid.astro';
import { getCollection } from 'astro:content';
import { getPostsByAuthor, getPostsByTag } from '../../lib/news';
import { marked } from 'marked';
import { readFileSync } from 'node:fs';
import { fileURLToPath } from 'node:url';
import { join, dirname } from 'node:path';

export async function getStaticPaths() {
  const teamMembers = await getCollection('team');

  // Only generate paths for team members with hasPage: true
  return teamMembers
    .filter((member) => member.data.hasPage === true)
    .map((member) => ({
      params: { slug: member.data.slug },
      props: { member },
    }));
}

const { member } = Astro.props;

if (!member || !member.data.hasPage) {
  return Astro.redirect('/404');
}

// Helper function to parse frontmatter and content from markdown
function parseMarkdown(markdown: string) {
  const frontmatterRegex = /^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/;
  const match = markdown.match(frontmatterRegex);

  if (match) {
    const frontmatter = match[1];
    const content = match[2];
    return { frontmatter, content };
  }

  // If no frontmatter, return the whole thing as content
  return { frontmatter: '', content: markdown };
}

// Try to load markdown file for this team member
let markdownContent: string | null = null;
const targetSlug = member.data.slug;

// Get the current file's directory and build path to markdown file
const currentFile = fileURLToPath(import.meta.url);
const currentDir = dirname(currentFile);
const markdownPath = join(
  currentDir,
  '..',
  '..',
  'content',
  'team',
  `${targetSlug}.md`
);

try {
  const rawMarkdown = readFileSync(markdownPath, 'utf-8');
  const { content } = parseMarkdown(rawMarkdown);
  markdownContent = marked.parse(content.trim()) as string;
} catch (error) {
  // Markdown file doesn't exist for this team member, which is fine
  markdownContent = null;
}

const {
  name,
  title,
  bio,
  hoverLine,
  linkedin,
  twitter,
  github,
  bluesky,
  website,
  includePosts,
  authorName,
} = member.data;

// Get posts by this author if they have includePosts enabled
// also add posts where their name is in tags
// then sort by publication date
let authorPosts: any[] = [];
if (includePosts && authorName) {
  authorPosts = await getPostsByAuthor(authorName);
}

// Get posts where the team member's name appears in tags
const postsByTag = await getPostsByTag(name);

// Combine both arrays and remove duplicates by post ID using a Map
const postsMap = new Map();
[...authorPosts, ...postsByTag].forEach((post) => {
  if (!postsMap.has(post.id)) {
    postsMap.set(post.id, post);
  }
});

// Convert Map values to array and sort by publication date (newest first)
const sortedPosts = Array.from(postsMap.values()).sort(
  (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// SEO-optimized title and description
const pageTitle = `${name} - ${title} | PWV`;
// Use hoverLine as primary description if available, otherwise use a shortened bio
const description =
  hoverLine || (bio.length > 160 ? `${bio.substring(0, 157)}...` : bio);
const keywords = `${name}, ${title}, PWV, venture capital, early-stage investing, general partner`;
---

<Layout
  title={pageTitle}
  description={description}
  keywords={keywords}
  author={name}
  enableUTMTracking={true}
  contentType="team"
  contentSlug={member.data.slug}
>
  <section class="mx-auto space-y-4">
    <Heading1>{name}</Heading1>

    <Heading2NoUnderline>{title}</Heading2NoUnderline>
  </section>

  <p class="mt-6 max-w-screen-md text-lg leading-relaxed">
    {bio}
  </p>

  <!-- Social Links -->
  {
    (linkedin || twitter || github || bluesky || website) && (
      <div class="mt-6 flex gap-3">
        {linkedin && <LinkedInLink handle={linkedin} />}
        {twitter && <TwitterLink handle={twitter} />}
        {bluesky && <BlueskyLink handle={bluesky} />}
        {github && <GitHubLink handle={github} />}
        {website && <WebsiteLink url={website} />}
      </div>
    )
  }

  <!-- Markdown Content -->
  {
    markdownContent && (
      <div
        class="prose prose-lg mt-8 max-w-screen-lg leading-relaxed"
        set:html={markdownContent}
      />
    )
  }

  {
    sortedPosts.length > 0 && (
      <section class="mt-12 space-y-6">
        <Heading2NoUnderline>Articles by {name}</Heading2NoUnderline>
        <PostsGrid posts={sortedPosts} size="large" />
      </section>
    )
  }

  <div class="mt-12 text-center">
    <a
      href="/about"
      class="bg-pwv-black text-pwv-white inline-flex items-center gap-2 rounded-lg px-5 py-2 text-sm"
    >
      <svg
        class="h-4 w-4"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M15 19l-7-7 7-7"></path>
      </svg>
      Back to Team
    </a>
  </div>
</Layout>
